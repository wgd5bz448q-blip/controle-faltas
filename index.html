<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle de Faltas</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <style>
      :root {
        --bg: #f4f6fb;
        --card: #ffffff;
        --text: #1f2a37;
        --muted: #6b7280;
        --primary: #0f766e;
        --primary-hover: #0b5f59;
        --border: #dbe2ea;
        --danger: #b91c1c;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(180deg, #eef2ff 0%, var(--bg) 40%);
        color: var(--text);
        min-height: 100vh;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      .header {
        margin-bottom: 18px;
      }

      .header h1 {
        margin: 0 0 6px;
        font-size: clamp(1.4rem, 2vw + 1rem, 2rem);
      }

      .header p {
        margin: 0;
        color: var(--muted);
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .field.full {
        grid-column: 1 / -1;
      }

      .hidden {
        display: none;
      }

      .modo-rapido {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        background: #eef6ff;
        border: 1px solid #cfe2ff;
        border-radius: 10px;
        padding: 10px 12px;
      }

      .modo-rapido p {
        margin: 0;
        font-weight: 600;
      }

      .aluno-btn {
        border: none;
        background: transparent;
        color: var(--text);
        font-size: 1em;
        font-weight: 700;
        padding: 0;
        cursor: pointer;
        text-align: left;
      }

      .aluno-btn:hover {
        color: var(--primary);
      }

      label {
        font-size: 0.92rem;
        font-weight: 600;
      }

      input,
      select,
      button {
        height: 42px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 0.95rem;
      }

      input,
      select {
        padding: 0 12px;
        background: #fff;
      }

      button {
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      button:hover {
        background: var(--primary-hover);
      }

      .table-wrap {
        margin-top: 20px;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 680px;
      }

      th,
      td {
        text-align: left;
        padding: 12px 10px;
        border-bottom: 1px solid var(--border);
        font-size: 0.92rem;
      }

      th {
        color: var(--muted);
        font-weight: 700;
      }

      .empty {
        margin: 14px 0 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .status {
        margin: 0 0 12px;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .auth-bar {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: flex-end;
        margin-bottom: 8px;
      }

      .auth-actions {
        display: flex;
        gap: 14px;
        align-items: center;
      }

      .auth-indicador {
        display: inline-flex;
        align-items: center;
        padding: 0;
        border-radius: 0;
        font-weight: 700;
      }

      .auth-indicador.on {
        color: #0f766e;
      }

      .auth-indicador.off {
        color: #b91c1c;
      }

      #btn-abrir-cadastro,
      #btn-logout,
      #btn-login-google,
      #btn-voltar-site,
      #btn-avancar-site {
        background: transparent;
        border: none;
        color: #334155;
        padding: 0;
        border-radius: 0;
        min-width: unset;
        height: auto;
        font-size: 1.05rem;
        font-weight: 700;
      }

      #btn-abrir-cadastro:hover,
      #btn-logout:hover,
      #btn-login-google:hover,
      #btn-voltar-site:hover,
      #btn-avancar-site:hover {
        background: transparent;
        color: #0f766e;
      }

      .section-divider {
        border: none;
        border-top: 1px solid var(--border);
        margin: 10px 0 12px;
      }

      .cadastro-toolbar {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 8px;
      }

      .btn-danger {
        background: var(--danger);
        border: none;
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .btn-secondary {
        background: #334155;
        border: none;
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .btn-primary {
        background: var(--primary);
        border: none;
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .auth-actions .btn-secondary,
      .auth-actions .btn-primary {
        min-width: 120px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .acoes-btn {
        width: 42px;
        height: 42px;
        padding: 0;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: #334155;
        font-size: 1.15rem;
        line-height: 1;
      }

      .acoes-btn:hover {
        background: #f8fafc;
      }

      .acoes-btn.danger {
        color: var(--danger);
        border-color: #fecaca;
      }

      .acoes-btn.danger:hover {
        background: #fef2f2;
      }

      #acoes-cadastro button {
        min-width: 220px;
        height: 46px;
        padding: 0 16px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.95rem;
        line-height: 1;
      }

      .cadastro-detalhes {
        margin-top: 16px;
        border-top: 1px solid var(--border);
        padding-top: 12px;
      }

      .cadastro-detalhes summary {
        list-style: none;
        cursor: pointer;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 12px;
      }

      .cadastro-detalhes summary::-webkit-details-marker {
        display: none;
      }

      .cadastro-detalhes summary.resumo-oculto {
        display: none;
      }

      .disciplina-tabs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .resumo-dia {
        margin-top: 14px;
        border: 1px solid #d7e2ef;
        border-radius: 12px;
        padding: 12px;
        background: #f8fbff;
      }

      .resumo-dia h3 {
        margin: 0 0 8px;
      }

      .resumo-dia-topo {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 8px;
        align-items: end;
        margin-bottom: 8px;
      }

      .resumo-dia-lista {
        margin: 0;
        padding-left: 18px;
      }

      .resumo-dia-lista li {
        margin: 4px 0;
      }

      .tab-btn {
        background: #e7eef6;
        color: #1f2a37;
        border: 1px solid #c8d5e4;
        font-weight: 600;
      }

      .tab-btn.ativo {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }

      @media (max-width: 700px) {
        .form-grid {
          grid-template-columns: 1fr;
        }

        .container {
          padding-top: 18px;
        }

        .disciplina-tabs {
          grid-template-columns: 1fr;
        }

        .resumo-dia-topo {
          grid-template-columns: 1fr;
        }

        .auth-actions {
          gap: 12px;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <header class="header">
        <h1>Faltas (Semiologia)</h1>
        <p>1¬∫ semestre 2026</p>
      </header>

      <section class="card">
        <div class="auth-bar">
          <div class="auth-actions">
            <button id="btn-voltar-site" type="button" class="btn-secondary" title="Voltar" aria-label="Voltar">‚Üê</button>
            <button id="btn-avancar-site" type="button" class="btn-secondary" title="Avan√ßar" aria-label="Avan√ßar">‚Üí</button>
            <button id="btn-login-google" type="button" class="btn-primary" title="Entrar com Google" aria-label="Entrar com Google">Entrar</button>
            <span id="auth-indicador" class="auth-indicador off">Off</span>
            <button id="btn-logout" type="button" class="btn-secondary" style="display: none" title="Sair" aria-label="Sair">Sair</button>
          </div>
        </div>
        <p id="usuario-logado" class="status" style="margin: 0 0 8px">Nao autenticado.</p>
        <p id="status-conexao" class="status">Conectando...</p>
        <hr class="section-divider" />
        <div class="cadastro-toolbar">
          <button id="btn-abrir-cadastro" type="button" class="btn-secondary" title="Cadastro" aria-label="Cadastro">Cadastro</button>
        </div>

        <details id="painel-cadastro" class="cadastro-detalhes">
          <summary id="resumo-cadastro" class="resumo-oculto">Cadastro</summary>
          <form id="faltas-form" class="form-grid">
            <div id="campo-modo-rapido" class="field full hidden">
              <div class="modo-rapido">
                <p id="aluno-selecionado-rapido"></p>
              </div>
            </div>

            <div id="campo-nome" class="field full">
              <label for="nome">Nome do aluno</label>
              <input id="nome" name="nome" type="text" placeholder="Ex.: Maria Oliveira" list="alunos-lista" required />
              <datalist id="alunos-lista"></datalist>
            </div>

            <div id="campo-disciplina" class="field">
              <label>Unidade Curricular</label>
              <div class="disciplina-tabs" id="disciplina-form-tabs">
                <button class="tab-btn" type="button" data-role="disciplina-form-btn" data-value="Semiologia Cl√≠nica 1">
                  Semiologia Cl√≠nica 1
                </button>
                <button class="tab-btn" type="button" data-role="disciplina-form-btn" data-value="Semiologia Cl√≠nica 2">
                  Semiologia Cl√≠nica 2
                </button>
              </div>
              <input id="disciplina" name="disciplina" type="hidden" value="Semiologia Cl√≠nica 1" required />
            </div>

            <div class="field">
              <label for="data">Data da aula</label>
              <input id="data" name="data" type="date" required />
            </div>

            <div class="field">
              <label for="falta">Falta (horas)</label>
              <select id="falta" name="falta" required>
                <option value="">Selecione</option>
                <option value="1">1h</option>
                <option value="2">2h</option>
                <option value="3">3h</option>
                <option value="4">4h</option>
                <option value="5">5h</option>
              </select>
            </div>

            <div id="campo-toggle-observacao" class="field">
              <label style="font-weight: 600; cursor: pointer">
                <input id="usar-observacao" type="checkbox" style="height: auto; margin-right: 8px" />
                Adicionar observacao deste dia
              </label>
            </div>

            <div id="campo-observacao" class="field hidden">
              <label for="observacao">Observa√ß√£o (opcional)</label>
              <input id="observacao" name="observacao" type="text" placeholder="Ex.: atestado pendente" />
            </div>

            <div class="field full">
              <div id="acoes-cadastro" style="display: flex; gap: 8px; flex-wrap: wrap">
                <button id="btn-cadastrar-aluno" type="button" class="btn-secondary" title="Cadastrar aluno" aria-label="Cadastrar aluno">
                  Cadastrar aluno
                </button>
                <button type="submit" title="Confirmar falta" aria-label="Confirmar falta">Confirmar falta</button>
              </div>
            </div>
          </form>
        </details>

        <div id="painel-turma" class="table-wrap">
          <div class="field" style="max-width: 520px; margin-bottom: 12px">
            <label>Unidade Curricular exibida na tabela</label>
            <div class="disciplina-tabs" id="filtro-disciplina-tabs">
              <button class="tab-btn" type="button" data-role="filtro-disciplina-btn" data-value="Semiologia Cl√≠nica 1">
                Semiologia Cl√≠nica 1
              </button>
              <button class="tab-btn" type="button" data-role="filtro-disciplina-btn" data-value="Semiologia Cl√≠nica 2">
                Semiologia Cl√≠nica 2
              </button>
            </div>
            <input id="filtro-disciplina" name="filtro-disciplina" type="hidden" value="Semiologia Cl√≠nica 1" />
          </div>
          <p id="titulo-tabela" style="margin: 0 0 8px; font-weight: 700"></p>
          <table aria-label="Registros de faltas">
            <thead>
              <tr>
                <th>Aluno</th>
                <th>Total</th>
                <th>√öltima falta</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody id="lista-faltas"></tbody>
          </table>
          <p id="mensagem-vazia" class="empty">Nenhuma falta registrada ainda.</p>

          <section class="resumo-dia" aria-live="polite">
            <h3>Faltas do dia</h3>
            <div class="resumo-dia-topo">
              <div class="field" style="margin: 0">
                <label for="filtro-data-dia">Dia da consulta</label>
                <input id="filtro-data-dia" type="date" />
              </div>
              <button id="btn-listar-faltas-dia" type="button" class="btn-secondary" style="height: 44px">Listar</button>
              <button id="btn-copiar-faltas-dia" type="button" class="btn-secondary" style="height: 44px">Copiar faltas do dia</button>
            </div>
            <p id="titulo-faltas-dia" style="margin: 0 0 6px; font-weight: 700"></p>
            <ul id="lista-faltas-dia" class="resumo-dia-lista"></ul>
            <p id="mensagem-faltas-dia" class="empty" style="display: none"></p>
          </section>
        </div>
      </section>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="./firebase-config.js"></script>
    <script>
      const painelCadastro = document.getElementById("painel-cadastro");
      const resumoCadastro = document.getElementById("resumo-cadastro");
      const form = document.getElementById("faltas-form");
      const lista = document.getElementById("lista-faltas");
      const mensagemVazia = document.getElementById("mensagem-vazia");
      const statusConexao = document.getElementById("status-conexao");
      const usuarioLogado = document.getElementById("usuario-logado");
      const btnLoginGoogle = document.getElementById("btn-login-google");
      const btnLogout = document.getElementById("btn-logout");
      const btnVoltarSite = document.getElementById("btn-voltar-site");
      const btnAvancarSite = document.getElementById("btn-avancar-site");
      const btnAbrirCadastro = document.getElementById("btn-abrir-cadastro");
      const btnCadastrarAluno = document.getElementById("btn-cadastrar-aluno");
      const authIndicador = document.getElementById("auth-indicador");
      const usarObservacao = document.getElementById("usar-observacao");
      const campoObservacao = document.getElementById("campo-observacao");
      const campoToggleObservacao = document.getElementById("campo-toggle-observacao");
      const campoNome = document.getElementById("campo-nome");
      const campoDisciplina = document.getElementById("campo-disciplina");
      const campoModoRapido = document.getElementById("campo-modo-rapido");
      const painelTurma = document.getElementById("painel-turma");
      const acoesCadastro = document.getElementById("acoes-cadastro");
      const alunoSelecionadoRapido = document.getElementById("aluno-selecionado-rapido");
      const nomeInput = document.getElementById("nome");
      const dataInput = document.getElementById("data");
      const faltaInput = document.getElementById("falta");
      const listaAlunos = document.getElementById("alunos-lista");
      const filtroDisciplina = document.getElementById("filtro-disciplina");
      const filtroDataDia = document.getElementById("filtro-data-dia");
      const btnListarFaltasDia = document.getElementById("btn-listar-faltas-dia");
      const btnCopiarFaltasDia = document.getElementById("btn-copiar-faltas-dia");
      const tituloFaltasDia = document.getElementById("titulo-faltas-dia");
      const listaFaltasDia = document.getElementById("lista-faltas-dia");
      const mensagemFaltasDia = document.getElementById("mensagem-faltas-dia");
      const tituloTabela = document.getElementById("titulo-tabela");
      const disciplinaInput = document.getElementById("disciplina");
      const botoesFiltroDisciplina = document.querySelectorAll('[data-role="filtro-disciplina-btn"]');
      const botoesDisciplinaForm = document.querySelectorAll('[data-role="disciplina-form-btn"]');

      const STORAGE_KEY = "controle_faltas_registros_v1";
      const registros = [];
      let usandoFirebase = false;
      let db = null;
      let auth = null;
      let unsubscribeRegistros = null;

      const salvarRegistrosLocal = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));
      };

      const carregarRegistrosLocal = () => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;

        try {
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return;

          registros.push(
            ...parsed.filter(
              (item) =>
                item &&
                typeof item.nome === "string" &&
                typeof item.disciplina === "string" &&
                typeof item.data === "string" &&
                typeof item.falta === "string"
            )
          );
        } catch (_error) {
          localStorage.removeItem(STORAGE_KEY);
        }
      };

      const setStatusConexao = (texto) => {
        statusConexao.textContent = texto;
      };

      const setUsuario = (texto) => {
        usuarioLogado.textContent = texto;
      };

      const atualizarUIAutenticacao = (user) => {
        if (user) {
          authIndicador.textContent = "On";
          authIndicador.classList.remove("off");
          authIndicador.classList.add("on");
          btnLoginGoogle.style.display = "none";
          btnLogout.style.display = "inline-flex";
          return;
        }

        authIndicador.textContent = "Off";
        authIndicador.classList.remove("on");
        authIndicador.classList.add("off");
        btnLoginGoogle.textContent = "Entrar";
        btnLoginGoogle.disabled = false;
        btnLoginGoogle.style.display = "inline-flex";
        btnLogout.style.display = "none";
      };

      const atualizarCampoObservacao = () => {
        const ativo = Boolean(usarObservacao.checked);
        campoObservacao.classList.toggle("hidden", !ativo);
        if (!ativo) {
          const inputObservacao = document.getElementById("observacao");
          inputObservacao.value = "";
        }
      };

      const atualizarModoLancamento = (rapido, nome = "") => {
        campoNome.classList.toggle("hidden", rapido);
        campoDisciplina.classList.toggle("hidden", rapido);
        campoModoRapido.classList.toggle("hidden", !rapido);
        campoToggleObservacao.classList.remove("hidden");
        if (rapido) {
          usarObservacao.checked = false;
          atualizarCampoObservacao();
        }
        btnCadastrarAluno.style.display = rapido ? "none" : "inline-flex";
        acoesCadastro.style.justifyContent = rapido ? "flex-start" : "flex-start";
        alunoSelecionadoRapido.textContent = rapido ? `Aluno selecionado: ${nome}` : "";
      };

      const formatarData = (isoDate) => {
        const [ano, mes, dia] = isoDate.split("-");
        return `${dia}/${mes}/${ano}`;
      };

      const dataHojeISO = () => {
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, "0");
        const dia = String(hoje.getDate()).padStart(2, "0");
        return `${ano}-${mes}-${dia}`;
      };

      const preencherDataComHoje = () => {
        dataInput.value = dataHojeISO();
      };

      const escapeHtml = (texto) =>
        texto
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");

      const normalizarNome = (nome) => String(nome || "").trim().toLocaleLowerCase("pt-BR");

      const existeAlunoNaDisciplina = (nome, disciplina) => {
        const nomeNormalizado = normalizarNome(nome);
        return registros.some(
          (registro) =>
            registro.disciplina === disciplina && normalizarNome(registro.nome) === nomeNormalizado
        );
      };

      const atualizarListaAlunos = () => {
        const nomesUnicos = [...new Set(registros.map((r) => r.nome.trim()).filter(Boolean))].sort((a, b) =>
          a.localeCompare(b, "pt-BR")
        );

        listaAlunos.innerHTML = nomesUnicos.map((nome) => `<option value="${nome}"></option>`).join("");
      };

      const atualizarPainelCadastro = () => {
        painelTurma.classList.toggle("hidden", painelCadastro.open);
        if (painelCadastro.open) {
          btnAbrirCadastro.textContent = "Fechar";
          return;
        }
        btnAbrirCadastro.textContent = "Cadastro";
      };

      const ajustarPainelPorDados = () => {
        painelCadastro.open = registros.length === 0;
        atualizarPainelCadastro();
      };

      const atualizarBotoesDisciplina = (botoes, valorAtivo) => {
        botoes.forEach((botao) => {
          const ativo = botao.dataset.value === valorAtivo;
          botao.classList.toggle("ativo", ativo);
          botao.setAttribute("aria-pressed", String(ativo));
        });
      };

      const atualizarTabela = () => {
        const disciplinaSelecionada = filtroDisciplina.value;
        tituloTabela.textContent = `Registros de faltas - ${disciplinaSelecionada}`;
        lista.innerHTML = "";
        const registrosFiltrados = registros.filter((registro) => registro.disciplina === disciplinaSelecionada);

        if (registrosFiltrados.length === 0) {
          mensagemVazia.textContent = `Nenhuma falta registrada em ${disciplinaSelecionada}.`;
          mensagemVazia.style.display = "block";
          return;
        }

        mensagemVazia.style.display = "none";
        const alunos = new Map();

        registrosFiltrados.forEach((registro) => {
          const indice = registros.indexOf(registro);
          const nomeNormalizado = registro.nome.trim().toLocaleLowerCase("pt-BR");
          const faltaHoras = Number.parseInt(registro.falta, 10) || 0;

          if (!alunos.has(nomeNormalizado)) {
            alunos.set(nomeNormalizado, {
              nome: registro.nome.trim(),
              total: 0,
              ultimoRegistro: "-",
              ultimoIndice: indice,
              ultimoTimestamp: "",
              dias: [],
            });
          }

          const aluno = alunos.get(nomeNormalizado);
          aluno.total += faltaHoras;
          if (faltaHoras > 0 && (!aluno.ultimoTimestamp || registro.data >= aluno.ultimoTimestamp)) {
            aluno.ultimoRegistro = `${formatarData(registro.data)} (${faltaHoras}h)`;
            aluno.ultimoIndice = indice;
            aluno.ultimoTimestamp = registro.data;
          }
          if (faltaHoras > 0) {
            aluno.dias.push({
              data: registro.data,
              horas: faltaHoras,
              observacao: registro.observacao || "",
            });
          }
        });

        [...alunos.values()]
          .sort((a, b) => a.nome.localeCompare(b.nome, "pt-BR"))
          .forEach((aluno) => {
          const historico = [...aluno.dias]
            .sort((a, b) => a.data.localeCompare(b.data))
            .map((item) => {
              const obs = item.observacao ? ` - ${item.observacao}` : "";
              return `${formatarData(item.data)} (${item.horas}h)${obs}`;
            })
            .join(" | ");
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>
              <button class="aluno-btn" data-action="selecionar-aluno" data-nome="${escapeHtml(aluno.nome)}" type="button">
                ${escapeHtml(aluno.nome)}
              </button>
            </td>
            <td>${aluno.total}h</td>
            <td>${aluno.ultimoRegistro}</td>
            <td>
              <button class="acoes-btn" data-action="abrir-cadastro-completo" data-nome="${escapeHtml(aluno.nome)}" data-disciplina="${escapeHtml(disciplinaSelecionada)}" type="button" title="Cadastro completo" aria-label="Cadastro completo">‚öô</button>
              <button class="acoes-btn" data-action="copiar-falta" data-nome="${escapeHtml(aluno.nome)}" data-disciplina="${escapeHtml(disciplinaSelecionada)}" type="button" title="Copiar falta" aria-label="Copiar falta">üìã</button>
              <button class="acoes-btn" data-action="ver-dias" data-nome="${escapeHtml(aluno.nome)}" data-historico="${escapeHtml(historico)}" type="button" title="Ver dias" aria-label="Ver dias">üìÖ</button>
              <button class="acoes-btn danger" data-action="remover-aluno" data-nome="${escapeHtml(aluno.nome)}" data-disciplina="${escapeHtml(disciplinaSelecionada)}" type="button" title="Remover aluno" aria-label="Remover aluno">üóëÔ∏è</button>
            </td>
          `;
          lista.appendChild(tr);
        });

        atualizarListaFaltasDia();
      };

      const atualizarListaFaltasDia = () => {
        const disciplinaSelecionada = filtroDisciplina.value;
        const dataSelecionada = filtroDataDia.value;

        listaFaltasDia.innerHTML = "";
        mensagemFaltasDia.style.display = "none";

        if (!dataSelecionada) {
          tituloFaltasDia.textContent = "";
          mensagemFaltasDia.textContent = "Selecione uma data para listar as faltas.";
          mensagemFaltasDia.style.display = "block";
          return;
        }

        tituloFaltasDia.textContent = `${disciplinaSelecionada} - ${formatarData(dataSelecionada)}`;

        const faltasDoDia = registros.filter(
          (registro) =>
            registro.disciplina === disciplinaSelecionada &&
            registro.data === dataSelecionada &&
            (Number.parseInt(registro.falta, 10) || 0) > 0
        );

        if (faltasDoDia.length === 0) {
          mensagemFaltasDia.textContent = "Nenhum aluno com falta nessa data.";
          mensagemFaltasDia.style.display = "block";
          return;
        }

        const porAluno = new Map();

        faltasDoDia.forEach((registro) => {
          const chave = normalizarNome(registro.nome);
          const horas = Number.parseInt(registro.falta, 10) || 0;
          if (!porAluno.has(chave)) {
            porAluno.set(chave, { nome: registro.nome.trim(), horas: 0 });
          }
          porAluno.get(chave).horas += horas;
        });

        [...porAluno.values()]
          .sort((a, b) => a.nome.localeCompare(b.nome, "pt-BR"))
          .forEach((item) => {
            const li = document.createElement("li");
            li.textContent = `${item.nome} - ${item.horas}h`;
            listaFaltasDia.appendChild(li);
          });
      };

      const obterResumoFaltasDia = () => {
        const disciplinaSelecionada = filtroDisciplina.value;
        const dataSelecionada = filtroDataDia.value;

        if (!dataSelecionada) return null;

        const faltasDoDia = registros.filter(
          (registro) =>
            registro.disciplina === disciplinaSelecionada &&
            registro.data === dataSelecionada &&
            (Number.parseInt(registro.falta, 10) || 0) > 0
        );

        if (faltasDoDia.length === 0) return null;

        const porAluno = new Map();
        faltasDoDia.forEach((registro) => {
          const chave = normalizarNome(registro.nome);
          const horas = Number.parseInt(registro.falta, 10) || 0;
          if (!porAluno.has(chave)) {
            porAluno.set(chave, { nome: registro.nome.trim(), horas: 0 });
          }
          porAluno.get(chave).horas += horas;
        });

        const itens = [...porAluno.values()].sort((a, b) => a.nome.localeCompare(b.nome, "pt-BR"));
        return { disciplina: disciplinaSelecionada, data: dataSelecionada, itens };
      };

      const carregarRegistrosFirebase = () => {
        if (unsubscribeRegistros) unsubscribeRegistros();
        unsubscribeRegistros = db.collection("faltas").onSnapshot(
          (snapshot) => {
            registros.length = 0;
            snapshot.forEach((doc) => {
              const item = doc.data() || {};
              registros.push({
                id: doc.id,
                nome: String(item.nome || "").trim(),
                disciplina: String(item.disciplina || ""),
                data: String(item.data || ""),
                falta: String(item.faltaHoras || item.falta || ""),
                observacao: String(item.observacao || "").trim(),
              });
            });

            atualizarListaAlunos();
            atualizarTabela();
            ajustarPainelPorDados();
            setStatusConexao("Dados salvos na nuvem (Firebase).");
          },
          () => {
            setStatusConexao("Falha ao sincronizar com Firebase. Usando armazenamento local.");
            usandoFirebase = false;
            registros.length = 0;
            carregarRegistrosLocal();
            atualizarListaAlunos();
            atualizarTabela();
            ajustarPainelPorDados();
          }
        );
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const dados = new FormData(form);
        const novoRegistro = {
          nome: String(dados.get("nome")).trim(),
          disciplina: String(dados.get("disciplina")),
          data: String(dados.get("data")),
          falta: String(dados.get("falta")),
          observacao: String(dados.get("observacao")).trim(),
        };

        if (!novoRegistro.nome || !novoRegistro.disciplina || !novoRegistro.data || !novoRegistro.falta) return;

        if (usandoFirebase) {
          if (!auth.currentUser) {
            alert("Faca login para salvar na nuvem.");
            return;
          }
          try {
            await db.collection("faltas").add({
              nome: novoRegistro.nome,
              nomeNormalizado: novoRegistro.nome.toLocaleLowerCase("pt-BR"),
              disciplina: novoRegistro.disciplina,
              data: novoRegistro.data,
              faltaHoras: Number.parseInt(novoRegistro.falta, 10) || 0,
              observacao: novoRegistro.observacao,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          } catch (_error) {
            alert("Nao foi possivel salvar no Firebase.");
            return;
          }
        } else {
          registros.push(novoRegistro);
          salvarRegistrosLocal();
          atualizarListaAlunos();
          atualizarTabela();
        }

        filtroDisciplina.value = novoRegistro.disciplina;
        atualizarBotoesDisciplina(botoesFiltroDisciplina, filtroDisciplina.value);
        form.reset();
        atualizarModoLancamento(false);
        preencherDataComHoje();
        usarObservacao.checked = false;
        atualizarCampoObservacao();
        disciplinaInput.value = filtroDisciplina.value;
        atualizarBotoesDisciplina(botoesDisciplinaForm, disciplinaInput.value);
        painelCadastro.open = false;
        atualizarPainelCadastro();
      });

      botoesFiltroDisciplina.forEach((botao) => {
        botao.addEventListener("click", () => {
          filtroDisciplina.value = botao.dataset.value || "Semiologia Cl√≠nica 1";
          atualizarBotoesDisciplina(botoesFiltroDisciplina, filtroDisciplina.value);
          atualizarTabela();
        });
      });

      btnListarFaltasDia.addEventListener("click", atualizarListaFaltasDia);
      filtroDataDia.addEventListener("change", atualizarListaFaltasDia);
      btnCopiarFaltasDia.addEventListener("click", async () => {
        const resumo = obterResumoFaltasDia();
        if (!resumo) {
          alert("Nenhuma falta para copiar na data selecionada.");
          return;
        }

        const linhasAlunos = resumo.itens.map((item) => `- ${item.nome}: ${item.horas}h`).join("\n");
        const texto = `Disciplina: ${resumo.disciplina}\nData: ${formatarData(resumo.data)}\n\n${linhasAlunos}`;

        try {
          await navigator.clipboard.writeText(texto);
          alert("Lista de faltas copiada.");
        } catch (_error) {
          alert("Nao foi possivel copiar automaticamente.");
        }
      });

      botoesDisciplinaForm.forEach((botao) => {
        botao.addEventListener("click", () => {
          disciplinaInput.value = botao.dataset.value || "Semiologia Cl√≠nica 1";
          atualizarBotoesDisciplina(botoesDisciplinaForm, disciplinaInput.value);
        });
      });

      painelCadastro.addEventListener("toggle", atualizarPainelCadastro);

      lista.addEventListener("click", async (event) => {
        const alvo = event.target;
        if (!(alvo instanceof HTMLButtonElement)) return;
        const acao = alvo.dataset.action;

        if (acao === "selecionar-aluno") {
          const nome = (alvo.dataset.nome || "").trim();
          if (!nome) return;

          nomeInput.value = nome;
          disciplinaInput.value = filtroDisciplina.value;
          atualizarBotoesDisciplina(botoesDisciplinaForm, disciplinaInput.value);
          preencherDataComHoje();
          faltaInput.value = "";
          usarObservacao.checked = false;
          atualizarCampoObservacao();
          atualizarModoLancamento(true, nome);
          painelCadastro.open = true;
          atualizarPainelCadastro();
          return;
        }

        if (acao === "abrir-cadastro-completo") {
          const nome = (alvo.dataset.nome || "").trim();
          const disciplina = (alvo.dataset.disciplina || "").trim();
          if (!nome || !disciplina) return;

          atualizarModoLancamento(false);
          nomeInput.value = nome;
          disciplinaInput.value = disciplina;
          atualizarBotoesDisciplina(botoesDisciplinaForm, disciplinaInput.value);
          preencherDataComHoje();
          faltaInput.value = "";
          usarObservacao.checked = false;
          atualizarCampoObservacao();
          painelCadastro.open = true;
          atualizarPainelCadastro();
          nomeInput.focus();
          return;
        }

        if (acao === "ver-dias") {
          const nome = alvo.dataset.nome || "Aluno";
          const historico = (alvo.dataset.historico || "").split("|").map((item) => item.trim()).filter(Boolean);
          if (historico.length === 0) {
            alert(`Nenhuma data encontrada para ${nome}.`);
            return;
          }
          alert(`Faltas de ${nome}:\n\n- ${historico.join("\n- ")}`);
          return;
        }

        if (acao === "copiar-falta") {
          const nome = (alvo.dataset.nome || "").trim();
          const disciplina = (alvo.dataset.disciplina || "").trim();
          if (!nome || !disciplina) return;

          const dataSelecionada = dataInput.value || dataHojeISO();
          const nomeNormalizado = nome.toLocaleLowerCase("pt-BR");
          const candidatos = registros.filter(
            (registro) =>
              registro.disciplina === disciplina &&
              registro.data === dataSelecionada &&
              Number.parseInt(registro.falta, 10) > 0 &&
              registro.nome.trim().toLocaleLowerCase("pt-BR") === nomeNormalizado
          );

          if (candidatos.length === 0) {
            alert(`Sem falta registrada para ${nome} em ${formatarData(dataSelecionada)}.`);
            return;
          }

          const registroData = candidatos[candidatos.length - 1];
          const horas = Number.parseInt(registroData.falta, 10) || 0;
          const texto = `${nome} - ${formatarData(dataSelecionada)} - ${horas}h`;

          try {
            await navigator.clipboard.writeText(texto);
            alert(`Copiado: ${texto}`);
          } catch (_error) {
            alert("Nao foi possivel copiar automaticamente.");
          }
          return;
        }

        if (acao !== "remover-aluno") return;

        const nome = (alvo.dataset.nome || "").trim();
        const disciplina = (alvo.dataset.disciplina || "").trim();
        if (!nome || !disciplina) return;

        const nomeNormalizado = nome.toLocaleLowerCase("pt-BR");

        if (usandoFirebase) {
          if (!auth.currentUser) {
            alert("Faca login para remover na nuvem.");
            return;
          }
          try {
            const snapshot = await db.collection("faltas").where("disciplina", "==", disciplina).get();
            const batch = db.batch();
            snapshot.forEach((doc) => {
              const item = doc.data() || {};
              const nomeDoc = String(item.nome || "").trim().toLocaleLowerCase("pt-BR");
              if (nomeDoc !== nomeNormalizado) return;
              batch.delete(doc.ref);
            });
            await batch.commit();
          } catch (_error) {
            alert("Nao foi possivel remover aluno no Firebase.");
            return;
          }
        } else {
          for (let i = registros.length - 1; i >= 0; i -= 1) {
            const registro = registros[i];
            if (registro.disciplina !== disciplina) continue;
            if (registro.nome.trim().toLocaleLowerCase("pt-BR") !== nomeNormalizado) continue;
            registros.splice(i, 1);
          }

          salvarRegistrosLocal();
          atualizarListaAlunos();
          atualizarTabela();
        }
      });

      const iniciarArmazenamento = () => {
        const firebaseConfig = window.FIREBASE_CONFIG || null;
        const temConfigValida = Boolean(
          firebaseConfig &&
            firebaseConfig.apiKey &&
            firebaseConfig.authDomain &&
            firebaseConfig.projectId &&
            firebaseConfig.appId
        );

        if (!temConfigValida || typeof firebase === "undefined") {
          setStatusConexao("Usando armazenamento local. Configure FIREBASE_CONFIG para sincronizar na nuvem.");
          carregarRegistrosLocal();
          atualizarListaAlunos();
          atualizarTabela();
          ajustarPainelPorDados();
          return;
        }

        try {
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }
          auth = firebase.auth();
          db = firebase.firestore();
          usandoFirebase = true;

          auth
            .setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
              auth.onAuthStateChanged((user) => {
                if (user) {
                  setUsuario(`Logado: ${user.email || user.displayName || "Usuario"}`);
                  atualizarUIAutenticacao(user);
                  setStatusConexao("Conectando ao Firebase...");
                  carregarRegistrosFirebase();
                  return;
                }

                setUsuario("Nao autenticado.");
                atualizarUIAutenticacao(null);
                setStatusConexao("Faca login para sincronizar na nuvem.");
                if (unsubscribeRegistros) {
                  unsubscribeRegistros();
                  unsubscribeRegistros = null;
                }
                registros.length = 0;
                carregarRegistrosLocal();
                atualizarListaAlunos();
                atualizarTabela();
                ajustarPainelPorDados();
              });
            })
            .catch(() => {
              setStatusConexao("Nao foi possivel manter sessao. Tente login novamente.");
            });
        } catch (_error) {
          usandoFirebase = false;
          setStatusConexao("Falha ao iniciar Firebase. Usando armazenamento local.");
          atualizarUIAutenticacao(null);
          carregarRegistrosLocal();
          atualizarListaAlunos();
          atualizarTabela();
          ajustarPainelPorDados();
        }
      };

      btnLoginGoogle.addEventListener("click", async () => {
        if (!usandoFirebase || !auth) {
          alert("Firebase nao configurado.");
          return;
        }
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: "select_account" });
        try {
          await auth.signInWithPopup(provider);
        } catch (error) {
          const codigo = error && error.code ? error.code : "erro-desconhecido";
          if (codigo === "auth/popup-blocked") {
            alert("Popup bloqueado. Permita popups para este site e tente novamente.");
            return;
          }
          if (codigo === "auth/popup-closed-by-user" || codigo === "auth/cancelled-popup-request") {
            alert("Login cancelado.");
            return;
          }
          alert(`Falha no login Google (${codigo}).`);
        }
      });

      btnLogout.addEventListener("click", async () => {
        if (!usandoFirebase || !auth) return;
        try {
          await auth.signOut();
        } catch (_error) {
          alert("Nao foi possivel sair.");
        }
      });

      btnVoltarSite.addEventListener("click", () => {
        window.history.back();
      });

      btnAvancarSite.addEventListener("click", () => {
        window.history.forward();
      });

      btnAbrirCadastro.addEventListener("click", () => {
        painelCadastro.open = !painelCadastro.open;
        if (painelCadastro.open) {
          form.reset();
          atualizarModoLancamento(false);
          preencherDataComHoje();
          usarObservacao.checked = false;
          atualizarCampoObservacao();
          disciplinaInput.value = filtroDisciplina.value;
          atualizarBotoesDisciplina(botoesDisciplinaForm, disciplinaInput.value);
          nomeInput.focus();
        }
        atualizarPainelCadastro();
      });

      btnCadastrarAluno.addEventListener("click", async () => {
        const nome = nomeInput.value.trim();
        const disciplina = disciplinaInput.value;
        if (!nome || !disciplina) {
          alert("Preencha nome e disciplina para cadastrar o aluno.");
          return;
        }

        if (existeAlunoNaDisciplina(nome, disciplina)) {
          alert("Este aluno ja esta cadastrado nesta disciplina.");
          return;
        }

        const registroCadastro = {
          nome,
          disciplina,
          data: dataHojeISO(),
          falta: "0",
          observacao: "",
        };

        if (usandoFirebase) {
          if (!auth.currentUser) {
            alert("Faca login para cadastrar na nuvem.");
            return;
          }
          try {
            await db.collection("faltas").add({
              nome: registroCadastro.nome,
              nomeNormalizado: registroCadastro.nome.toLocaleLowerCase("pt-BR"),
              disciplina: registroCadastro.disciplina,
              data: registroCadastro.data,
              faltaHoras: 0,
              observacao: "",
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          } catch (_error) {
            alert("Nao foi possivel cadastrar aluno no Firebase.");
            return;
          }
        } else {
          registros.push(registroCadastro);
          salvarRegistrosLocal();
          atualizarListaAlunos();
          atualizarTabela();
        }

        filtroDisciplina.value = disciplina;
        atualizarBotoesDisciplina(botoesFiltroDisciplina, filtroDisciplina.value);
        form.reset();
        preencherDataComHoje();
        atualizarModoLancamento(false);
        usarObservacao.checked = false;
        atualizarCampoObservacao();
        disciplinaInput.value = filtroDisciplina.value;
        atualizarBotoesDisciplina(botoesDisciplinaForm, disciplinaInput.value);
        painelCadastro.open = false;
        atualizarPainelCadastro();
      });

      usarObservacao.addEventListener("change", atualizarCampoObservacao);

      atualizarBotoesDisciplina(botoesFiltroDisciplina, filtroDisciplina.value);
      atualizarBotoesDisciplina(botoesDisciplinaForm, disciplinaInput.value);
      atualizarUIAutenticacao(null);
      atualizarModoLancamento(false);
      preencherDataComHoje();
      filtroDataDia.value = dataHojeISO();
      atualizarCampoObservacao();
      iniciarArmazenamento();
    </script>
  </body>
</html>
